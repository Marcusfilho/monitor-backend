<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>APP V1 - Installations (v1.2)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    input, select, button { padding: 8px; margin: 6px 0; width: 100%; max-width: 560px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-start; }
    .col { flex: 1; min-width: 280px; }
    pre { background: #111; color: #eee; padding: 12px; overflow: auto; max-height: 420px; }
    .muted { color: #666; font-size: 12px; }
    .warn { color: #b36b00; font-size: 12px; }
    .ok { color: #1a7f37; font-size: 12px; }
    hr { margin: 12px 0; }
  </style>
</head>
<body>
  <h2>APP V1 (provisório) — Installations (v1.2)</h2>
  <div class="muted">
    Carrega catálogos no front-end e envia no payload: clientId/vehicleSettingId (Monitor), assetType (HTML5) e comando do G-sensor.
  </div>

  <div class="row">
    <div class="col">
      <label>Service</label>
      <select id="service">
        <option>INSTALL</option>
        <option>UNINSTALL</option>
        <option>MAINT_NO_SWAP</option>
        <option>MAINT_WITH_SWAP</option>
      </select>

      <hr/>
      <div class="muted">Cliente + Setting (Monitor / Scheme Builder)</div>

      <label>Cliente (nome)</label>
      <select id="clientSelect"></select>
      <div class="muted" id="clientMeta"></div>

      <label>target_client_id</label>
      <input id="target_client_id" placeholder="ex: 218572" />

      <label>vehicleSettingId (Monitor)</label>
      <input id="vehicleSettingId" placeholder="ex: 5592" />

      <hr/>
      <div class="muted">Identificação do veículo</div>

      <label>Lookup (license atual / serial em placa)</label>
      <input id="lookup_license" placeholder="ex: 913055459" />
      <div class="warn" id="hintLookup" style="display:none">
        Bancada: se o veículo de pré-teste está com license=serial, use o serial aqui para resolver o vehicle_id.
        O payload envia <b>plate = lookup_license</b> quando este campo está preenchido.
      </div>

      <label>Placa final (opcional)</label>
      <input id="plate_real" placeholder="ex: BOI0A12" />
      <div class="muted">No smoke test, pode deixar vazio. No futuro, o backend/worker deve aplicar essa placa no SAVE.</div>

      <div id="rowSerial">
        <label>Serial (new)</label>
        <input id="serial" placeholder="ex: 913055459" />
      </div>

      <hr id="hrInstall"/>
      <div id="blockInstall">
        <div class="muted">Modelo (HTML5) — seleciona o <b>assetType</b> (vira ASSET_TYPE no SAVE_VHCL_ACTIVATION_NEW)</div>

        <label>Fabricante</label>
        <select id="cat_manufacturer"></select>

        <label>Modelo</label>
        <select id="cat_model"></select>

        <label>assetType (id do modelo)</label>
        <input id="assetType" readonly />
      </div>

      <hr/>
      <div class="muted">G-Sensor — orientação/instalação</div>

      <label>Etiqueta (label)</label>
      <select id="gs_label"></select>

      <label>Chicote (harness)</label>
      <select id="gs_harness"></select>

      <label>Comando (auto)</label>
      <input id="gs_command" readonly />

      <div class="muted">O payload envia: gsensor = { label, harness, command }.</div>

      <hr/>
      <button id="btnCreate">Criar instalação</button>

      <div class="muted">Preview do payload (antes de enviar)</div>
      <pre id="payloadPreview">{}</pre>
    </div>

    <div class="col">
      <label>installation_id</label>
      <input id="installation_id" />

      <label>installation_token</label>
      <input id="installation_token" />

      <div class="row">
        <button id="btnPoll" class="col">Poll status</button>
        <button id="btnSnap" class="col">Request CAN snapshot</button>
      </div>

      <div class="row">
        <button id="btnApprove" class="col">Approve CAN</button>
        <button id="btnOverride" class="col">Approve override</button>
      </div>

      <label>override reason</label>
      <input id="override_reason" value="vehicle_new_no_engineering" />

      <div class="muted">Saída do backend</div>
      <pre id="out">{}</pre>
    </div>
  </div>

<script>
const $ = (id) => document.getElementById(id);

function saveLs() {
  localStorage.setItem("inst_id", $("installation_id").value || "");
  localStorage.setItem("inst_tok", $("installation_token").value || "");
}
function loadLs() {
  $("installation_id").value = localStorage.getItem("inst_id") || "";
  $("installation_token").value = localStorage.getItem("inst_tok") || "";
}
loadLs();

async function api(path, opts={}) {
  const headers = Object.assign({ "content-type": "application/json" }, opts.headers || {});
  const r = await fetch(path, Object.assign({}, opts, { headers }));
  const t = await r.text();
  let j = null;
  try { j = JSON.parse(t); } catch (_) { j = { raw: t }; }
  return { status: r.status, json: j };
}

function showOut(x) { $("out").textContent = JSON.stringify(x, null, 2); }
function showPayload(x) { $("payloadPreview").textContent = JSON.stringify(x, null, 2); }

// ===== Catálogos =====
let CATALOG_TYPES = [];      // catalog_vehicle_type.json
let CATALOG_SETTINGS = [];   // catalog_vehicle_settings.json
let GS_COMMANDS = [];        // g-sensor_commands.json

function uniqSorted(arr){ return [...new Set(arr)].sort((a,b)=>String(a).localeCompare(String(b))); }

async function loadJson(relPath){
  const r = await fetch(relPath, { cache: "no-store" });
  if (!r.ok) throw new Error(relPath + " HTTP " + r.status);
  return r.json();
}

async function loadCatalogs(){
  try {
    CATALOG_TYPES = await loadJson("catalog_vehicle_type.json");
    const s = await loadJson("catalog_vehicle_settings.json");
    CATALOG_SETTINGS = (s && s.items) ? s.items : [];
    const g = await loadJson("g-sensor_commands.json");
    GS_COMMANDS = (g && g.commands) ? g.commands : [];
  } catch (e) {
    showOut({ error: "Falha ao carregar JSONs. Confirme que estão na mesma pasta do HTML.", details: String(e) });
  }
  renderClients();
  renderManufacturers();
  renderGsSelectors();
  applyServiceUI();
  refreshPreview();
}

// ===== Cliente -> target_client_id + vehicleSettingId =====
function renderClients(){
  const sel = $("clientSelect");
  sel.innerHTML = "";
  const items = CATALOG_SETTINGS.slice().sort((a,b)=>
    String(a.clientName).localeCompare(String(b.clientName)) ||
    String(a.profileKey).localeCompare(String(b.profileKey))
  );

  for (const it of items){
    const o = document.createElement("option");
    o.value = String(it.clientId) + "|" + String(it.profileKey) + "|" + String(it.vehicleSettingId);
    o.textContent = `${it.clientName}  [${it.profileKey}]  → setting ${it.vehicleSettingId}` + (it.isDefault ? " (default)" : "");
    sel.appendChild(o);
  }

  // tenta pré-selecionar Translima default se existir
  const idx = items.findIndex(x => x.clientName === "TransLima" && x.profileKey === "default");
  if (idx >= 0) sel.selectedIndex = idx;

  applyClientSelection();
}

function applyClientSelection(){
  const v = $("clientSelect").value || "";
  const [clientId, profileKey, vehicleSettingId] = v.split("|");
  $("target_client_id").value = clientId || "";
  $("vehicleSettingId").value = vehicleSettingId || "";
  $("clientMeta").textContent = `clientId=${clientId} profileKey=${profileKey} vehicleSettingId=${vehicleSettingId}`;
  refreshPreview();
}
$("clientSelect").addEventListener("change", applyClientSelection);

// ===== Modelo -> assetType (HTML5) =====
function renderManufacturers(){
  const sel = $("cat_manufacturer");
  sel.innerHTML = "";
  const mans = uniqSorted(CATALOG_TYPES.map(x => x.manufacturer).filter(Boolean));
  for (const m of mans){
    const o = document.createElement("option");
    o.value = m; o.textContent = m;
    sel.appendChild(o);
  }
  renderModels();
}

function renderModels(){
  const man = $("cat_manufacturer").value;
  const sel = $("cat_model");
  sel.innerHTML = "";
  const models = uniqSorted(CATALOG_TYPES.filter(x => x.manufacturer === man).map(x => x.model).filter(Boolean));
  for (const m of models){
    const o = document.createElement("option");
    o.value = m; o.textContent = m;
    sel.appendChild(o);
  }
  updateAssetType();
}

function updateAssetType(){
  const man = $("cat_manufacturer").value;
  const model = $("cat_model").value;
  const it = CATALOG_TYPES.find(x => x.manufacturer === man && x.model === model);
  $("assetType").value = it ? String(it.asset_type) : "";
  refreshPreview();
}
$("cat_manufacturer").addEventListener("change", () => { renderModels(); });
$("cat_model").addEventListener("change", updateAssetType);

// ===== G-Sensor: label+harness -> command =====
function renderGsSelectors(){
  const labels = uniqSorted(GS_COMMANDS.map(x => x.label).filter(Boolean));
  const harness = uniqSorted(GS_COMMANDS.map(x => x.harness).filter(Boolean));

  const selL = $("gs_label"); selL.innerHTML = "";
  for (const l of labels){ const o=document.createElement("option"); o.value=l; o.textContent=l; selL.appendChild(o); }

  const selH = $("gs_harness"); selH.innerHTML = "";
  for (const h of harness){ const o=document.createElement("option"); o.value=h; o.textContent=h; selH.appendChild(o); }

  updateGsCommand();
}
function updateGsCommand(){
  const l = $("gs_label").value;
  const h = $("gs_harness").value;
  const it = GS_COMMANDS.find(x => x.label === l && x.harness === h);
  $("gs_command").value = it ? String(it.command) : "";
  refreshPreview();
}
$("gs_label").addEventListener("change", updateGsCommand);
$("gs_harness").addEventListener("change", updateGsCommand);

// ===== UI por serviço =====
function applyServiceUI(){
  const svc = $("service").value;
  const isInstall = (svc === "INSTALL");
  $("blockInstall").style.display = isInstall ? "" : "none";
  $("hrInstall").style.display = isInstall ? "" : "none";
  $("hintLookup").style.display = isInstall ? "" : "none";
  $("rowSerial").style.display = (svc === "INSTALL" || svc === "MAINT_WITH_SWAP") ? "" : "none";
  refreshPreview();
}
$("service").addEventListener("change", applyServiceUI);

// ===== Build payload =====
function buildPayload(){
  const svc = $("service").value;

  const lookup = $("lookup_license").value.trim();
  const plateReal = $("plate_real").value.trim();

  // compat: backend espera "plate" hoje. Para bancada, usamos lookup (serial em license).
  const plate = lookup || plateReal || "";

  const body = {
    service: svc,
    target_client_id: Number($("target_client_id").value || 0) || null,
    vehicleSettingId: Number($("vehicleSettingId").value || 0) || null,
    plate,
    plate_real: plateReal || null,         // futuro (não quebra hoje)
    lookup_license: lookup || null,        // futuro/diagnóstico (não quebra hoje)
    serial: $("serial").value.trim() || "",
    // G-Sensor: já envia comando resolvido pelo front-end
    gsensor: {
      label: $("gs_label").value,
      harness: $("gs_harness").value,
      command: $("gs_command").value
    }
  };

  if (svc === "INSTALL") {
    const assetType = Number($("assetType").value || 0) || null;
    body.assetType = assetType; // <- worker deve mapear isso para ASSET_TYPE no HTML5
    body.vehicle = {
      manufacturer: $("cat_manufacturer").value,
      model: $("cat_model").value,
      year: null
    };
  } else {
    // regra: não mandar assetType fora do INSTALL (evita sobrescrever modelo)
    delete body.assetType;
  }

  if (svc === "UNINSTALL" || svc === "MAINT_NO_SWAP") body.serial = "";

  return body;
}

function refreshPreview(){ showPayload(buildPayload()); }
["target_client_id","vehicleSettingId","lookup_license","plate_real","serial"].forEach(id => {
  $(id).addEventListener("input", refreshPreview);
});

$("btnCreate").onclick = async () => {
  const body = buildPayload();
  showPayload(body);
  window.__appV1_normalizeInstallPayloadV2(body);

  const __errs = window.__appV1_validateInstallPayloadV2(body);

  window.__appV1_renderPayloadPreviewV2(body);

  if (__errs.length) {

    alert('Payload inválido:
- ' + __errs.join('
- '));

    throw new Error('invalid payload: ' + __errs.join('; '));

  }

  const r = await api("/api/installations", { method: "POST", body: JSON.stringify(body) });
  showOut(r);
  if (r.json && r.json.ok) {
    $("installation_id").value = r.json.installation_id;
    $("installation_token").value = r.json.installation_token;
    saveLs();
  }
};

$("btnPoll").onclick = async () => {
  const id = $("installation_id").value.trim();
  const r = await api("/api/installations/" + encodeURIComponent(id));
  showOut(r);
};

$("btnSnap").onclick = async () => {
  const id = $("installation_id").value.trim();
  const tok = $("installation_token").value.trim();
  const r = await api("/api/installations/" + encodeURIComponent(id) + "/actions/request-can-snapshot", {
    method: "POST",
    headers: { "x-installation-token": tok },
    body: "{}"
  });
  showOut(r);
};

$("btnApprove").onclick = async () => {
  const id = $("installation_id").value.trim();
  const tok = $("installation_token").value.trim();
  const r = await api("/api/installations/" + encodeURIComponent(id) + "/actions/approve-can", {
    method: "POST",
    headers: { "x-installation-token": tok },
    body: JSON.stringify({ override: false })
  });
  showOut(r);
};

$("btnOverride").onclick = async () => {
  const id = $("installation_id").value.trim();
  const tok = $("installation_token").value.trim();
  const r = await api("/api/installations/" + encodeURIComponent(id) + "/actions/approve-can", {
    method: "POST",
    headers: { "x-installation-token": tok },
    body: JSON.stringify({ override: true, reason: $("override_reason").value })
  });
  showOut(r);
};

loadCatalogs();

/* === APP_V1_PAYLOAD_V2 === */
(function(){
  function normStr(v){ return String(v == null ? "" : v).trim(); }
  function up(v){ return normStr(v).toUpperCase(); }
  function first(obj, keys){
    for (const k of keys){
      if (!obj) break;
      const v = obj[k];
      if (v !== undefined && v !== null && String(v).trim() !== "") return v;
    }
    return null;
  }
  function toNumOrKeep(v){
    const t = normStr(v);
    if (!t) return null;
    const n = Number(t);
    return Number.isFinite(n) ? n : t;
  }

  // Normaliza o body antes do POST /api/installations
  window.__appV1_normalizeInstallPayloadV2 = function(body){
    body = body || {};
    const svc = up(first(body, ["service","servico","action","type","serviceType"])) || "INSTALL";
    body.service = svc;

    // valores "reais"
    const plateReal = normStr(first(body, ["plate_real","plateReal","LICENSE_REAL","license_real","licenseReal"])) ||
                      normStr(first(body, ["plate_vehicle","plateVehicle","placa_real","placaReal"])) ||
                      normStr(first(body, ["plate_input","plateInput"])) ||
                      "";

    const serial = normStr(first(body, ["serial","serie","innerId","inner_id","INNER_ID","DIAL_NUMBER"])) ||
                   "";

    // compat: alguns layouts antigos guardavam placa real em "plate" sem distinção
    const plateMaybe = normStr(first(body, ["plate","placa","license","licensePlate","LICENSE_NMBR"])) || "";

    const plate_real = plateReal or plateMaybe;
    body.plate_real = plate_real || null;

    // client/modelo/etc (mantém nomes canônicos + compat)
    const tgtClient = first(body, ["target_client_id","targetClientId","client_id","clientId","CLIENT_ID"]);
    if (tgtClient != null && String(tgtClient).trim() !== ""){
      const v = toNumOrKeep(tgtClient);
      body.target_client_id = v;
      body.client_id = v;     // compat
      body.CLIENT_ID = v;     // compat
    }

    const assetType = first(body, ["assetType","asset_type","vehicle_type","vehicleType","ASSET_TYPE"]);
    if (assetType != null && String(assetType).trim() !== ""){
      const v = toNumOrKeep(assetType);
      body.assetType = v;
      body.ASSET_TYPE = v;    // compat
    }

    // INSTALLED_BY / COMMENTS / DATE
    const installedBy = first(body, ["installedBy","instalador","installer","INSTALLED_BY"]);
    if (installedBy != null) body.installedBy = String(installedBy);

    const comments = first(body, ["comments","comment","observacoes","observations","COMMENTS"]);
    if (comments != null) body.comments = String(comments);

    const installationDate = first(body, ["installationDate","installation_date","installDate","date","data","INSTALLATION_DATE"]);
    if (installationDate != null) body.installationDate = String(installationDate);

    // gsensor (se existir)
    if (!body.gsensor){
      const cmd = normStr(first(body, ["gsensor_command","gsensorCommand","GSENSOR_COMMAND"])) || "";
      const label = normStr(first(body, ["label_pos","labelPos","LABEL_POS"])) || "";
      const harness = normStr(first(body, ["harness_pos","harnessPos","HARNESS_POS"])) || "";
      if (cmd || label || harness){
        body.gsensor = {
          command: cmd || null,
          label_pos: label || null,
          harness_pos: harness || null
        };
      }
    }

    // lookup_license: regra do plano
    const lookup = (svc === "INSTALL") ? (serial) : (plate_real);
    body.lookup_license = lookup || null;
    body.plate_lookup = lookup || null; // compat

    // *** compat com worker atual (VHCLS por payload.plate) ***
    body.plate = lookup || null;
    body.placa = lookup || null;

    // *** ajudar o SAVE (mesmo antes do patch do worker) ***
    if (plate_real){
      body.LICENSE_NMBR = plate_real;
      body.license_nmbr = plate_real;
    }
    if (serial){
      body.serial = serial;         // garante que não some
      body.INNER_ID = serial;
      body.DIAL_NUMBER = serial;
      body.inner_id = serial;
    }

    return body;
  };

  window.__appV1_validateInstallPayloadV2 = function(body){
    const errs = [];
    const svc = up(body && body.service) || "INSTALL";
    const plateReal = normStr(body && body.plate_real);
    const serial = normStr(body && body.serial);
    const client = body && (body.target_client_id ?? body.client_id ?? body.CLIENT_ID);
    const assetType = body && (body.assetType ?? body.ASSET_TYPE);

    if (!plateReal) errs.push("Placa real (plate_real) é obrigatória");

    if (svc === "INSTALL"){
      if (!serial) errs.push("Serial é obrigatório para INSTALL");
      if (client == null || String(client).trim()==="") errs.push("Cliente (target_client_id) é obrigatório para INSTALL");
      if (assetType == null || String(assetType).trim()==="") errs.push("Modelo (assetType/ASSET_TYPE) é obrigatório para INSTALL");
    }

    if (svc === "MAINT_WITH_SWAP"){
      if (!serial) errs.push("Serial novo é obrigatório para MAINT_WITH_SWAP");
    }

    return errs;
  };

  window.__appV1_renderPayloadPreviewV2 = function(body){
    try{
      let pre = document.getElementById("payloadPreviewV2");
      if (!pre){
        const box = document.createElement("details");
        box.open = true;
        box.style.margin = "12px 0";
        box.style.padding = "10px";
        box.style.border = "1px solid #ddd";
        box.style.borderRadius = "8px";
        const sum = document.createElement("summary");
        sum.textContent = "Payload (preview) — o que será enviado";
        sum.style.cursor = "pointer";
        pre = document.createElement("pre");
        pre.id = "payloadPreviewV2";
        pre.style.whiteSpace = "pre-wrap";
        pre.style.margin = "10px 0 0";
        box.appendChild(sum);
        box.appendChild(pre);
        // tenta anexar perto do log/out; senão vai pro final
        const anchor = document.getElementById("out") || document.getElementById("log") || document.body;
        anchor.appendChild(box);
      }
      pre.textContent = JSON.stringify(body, null, 2);
    }catch(e){}
  };
})();

</script>
</body>
</html>
