<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>APP V1 - Installations</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    input, select, button, textarea { padding: 8px; margin: 6px 0; width: 100%; max-width: 520px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .col { flex: 1; min-width: 240px; }
    pre { background: #111; color: #eee; padding: 12px; overflow: auto; max-height: 380px; }
    .muted { color: #666; font-size: 12px; }
    .warn { color: #b36b00; font-size: 12px; }
  </style>
</head>
<body>
  <h2>APP V1 (provisório) — Installations</h2>
  <div class="muted">Mesma origem do backend (sem CORS). Token fica salvo no localStorage.</div>

  <div class="row">
    <div class="col">
      <label>Service</label>
      <select id="service">
        <option>INSTALL</option>
        <option>UNINSTALL</option>
        <option>MAINT_NO_SWAP</option>
        <option>MAINT_WITH_SWAP</option>
      </select>

      <label>Target client_id</label>
      <input id="target_client_id" placeholder="ex: 218572" value="218572" />

      <label>Placa</label>
      <input id="plate" placeholder="ABC1D23" />
      <div class="warn" id="hintPlate" style="display:none">
        Dica bancada: se o veículo de pré-teste está com license=serial, use a "placa" = serial para resolver o vehicle_id (smoke test).
      </div>

      <div id="rowSerial">
        <label>Serial (new)</label>
        <input id="serial" placeholder="9123456789" />
      </div>

      <label>VehicleSettingId (opcional — Monitor)</label>
      <input id="vehicleSettingId" placeholder="ex: 5592" />

      <div id="rowCatalog">
        <hr/>
        <div class="muted">Modelo (HTML5) — seleciona o <b>assetType</b> (vira ASSET_TYPE no SAVE_VHCL_ACTIVATION_NEW)</div>

        <label>Fabricante (catálogo)</label>
        <select id="cat_manufacturer"></select>

        <label>Modelo (catálogo)</label>
        <select id="cat_model"></select>

        <label>assetType (id do modelo)</label>
        <input id="assetType" readonly />
      </div>

      <label>Etiqueta (label_pos)</label>
      <input id="label_pos" placeholder="LABEL_A" value="LABEL_A" />

      <label>Chicote (harness_pos)</label>
      <input id="harness_pos" placeholder="HARNESS_A" value="HARNESS_A" />

      <button id="btnCreate">Criar instalação</button>
    </div>

    <div class="col">
      <label>installation_id</label>
      <input id="installation_id" />

      <label>installation_token</label>
      <input id="installation_token" />

      <div class="row">
        <button id="btnPoll" class="col">Poll status</button>
        <button id="btnSnap" class="col">Request CAN snapshot</button>
      </div>

      <div class="row">
        <button id="btnApprove" class="col">Approve CAN</button>
        <button id="btnOverride" class="col">Approve override</button>
      </div>

      <label>override reason</label>
      <input id="override_reason" value="vehicle_new_no_engineering" />

      <pre id="out">{}</pre>
    </div>
  </div>

<script>
const $ = (id) => document.getElementById(id);

function saveLs() {
  localStorage.setItem("inst_id", $("installation_id").value || "");
  localStorage.setItem("inst_tok", $("installation_token").value || "");
}
function loadLs() {
  $("installation_id").value = localStorage.getItem("inst_id") || "";
  $("installation_token").value = localStorage.getItem("inst_tok") || "";
}
loadLs();

async function api(path, opts={}) {
  const headers = Object.assign({ "content-type": "application/json" }, opts.headers || {});
  const r = await fetch(path, Object.assign({}, opts, { headers }));
  const t = await r.text();
  let j = null;
  try { j = JSON.parse(t); } catch (_) { j = { raw: t }; }
  return { status: r.status, json: j };
}

function show(x) { $("out").textContent = JSON.stringify(x, null, 2); }

// ===== Catálogo (front-end) =====
let CATALOG = [];
function uniqSorted(arr){ return [...new Set(arr)].sort((a,b)=>String(a).localeCompare(String(b))); }

async function loadCatalog(){
  try {
    const r = await fetch("catalog_vehicle_type.json", { cache: "no-store" });
    if (!r.ok) throw new Error("HTTP " + r.status);
    CATALOG = await r.json();
  } catch (e) {
    show({ error: "Falha ao carregar catalog_vehicle_type.json (coloque ao lado do HTML).", details: String(e) });
    CATALOG = [];
  }
  renderManufacturers();
}

function renderManufacturers(){
  const sel = $("cat_manufacturer");
  sel.innerHTML = "";
  const mans = uniqSorted(CATALOG.map(x => x.manufacturer).filter(Boolean));
  for (const m of mans){
    const o = document.createElement("option");
    o.value = m; o.textContent = m;
    sel.appendChild(o);
  }
  renderModels();
}

function renderModels(){
  const man = $("cat_manufacturer").value;
  const sel = $("cat_model");
  sel.innerHTML = "";
  const models = uniqSorted(CATALOG.filter(x => x.manufacturer === man).map(x => x.model).filter(Boolean));
  for (const m of models){
    const o = document.createElement("option");
    o.value = m; o.textContent = m;
    sel.appendChild(o);
  }
  updateAssetType();
}

function updateAssetType(){
  const man = $("cat_manufacturer").value;
  const model = $("cat_model").value;
  const it = CATALOG.find(x => x.manufacturer === man && x.model === model);
  $("assetType").value = it ? String(it.asset_type) : "";
}

$("cat_manufacturer").addEventListener("change", renderModels);
$("cat_model").addEventListener("change", updateAssetType);

// ===== UI por serviço (mínimo) =====
function applyServiceUI(){
  const svc = $("service").value;
  $("rowCatalog").style.display = (svc === "INSTALL") ? "" : "none";
  $("hintPlate").style.display = (svc === "INSTALL") ? "" : "none";
  $("rowSerial").style.display = (svc === "INSTALL" || svc === "MAINT_WITH_SWAP") ? "" : "none";
}
$("service").addEventListener("change", applyServiceUI);
applyServiceUI();
loadCatalog();

// ===== Actions =====
$("btnCreate").onclick = async () => {
  const svc = $("service").value;

  const body = {
    service: svc,
    target_client_id: Number($("target_client_id").value || 0) || null,
    plate: $("plate").value.trim(),
    serial: $("serial").value.trim(),
    vehicleSettingId: Number($("vehicleSettingId").value || 0) || null,
    gsensor: { label_pos: $("label_pos").value, harness_pos: $("harness_pos").value }
  };

  // INSTALL: manda assetType (HTML5 ASSET_TYPE)
  if (svc === "INSTALL") {
    const assetType = Number($("assetType").value || 0) || null;
    body.assetType = assetType; // <- IMPORTANTÍSSIMO: o worker usa payload.assetType
    body.vehicle = {
      manufacturer: $("cat_manufacturer").value,
      model: $("cat_model").value,
      year: null
    };
  }

  // Serviços onde serial não faz sentido: limpa
  if (svc === "UNINSTALL" || svc === "MAINT_NO_SWAP") {
    body.serial = "";
  }

  const r = await api("/api/installations", { method: "POST", body: JSON.stringify(body) });
  show(r);
  if (r.json && r.json.ok) {
    $("installation_id").value = r.json.installation_id;
    $("installation_token").value = r.json.installation_token;
    saveLs();
  }
};

$("btnPoll").onclick = async () => {
  const id = $("installation_id").value.trim();
  const r = await api("/api/installations/" + encodeURIComponent(id));
  show(r);
};

$("btnSnap").onclick = async () => {
  const id = $("installation_id").value.trim();
  const tok = $("installation_token").value.trim();
  const r = await api("/api/installations/" + encodeURIComponent(id) + "/actions/request-can-snapshot", {
    method: "POST",
    headers: { "x-installation-token": tok },
    body: "{}"
  });
  show(r);
};

$("btnApprove").onclick = async () => {
  const id = $("installation_id").value.trim();
  const tok = $("installation_token").value.trim();
  const r = await api("/api/installations/" + encodeURIComponent(id) + "/actions/approve-can", {
    method: "POST",
    headers: { "x-installation-token": tok },
    body: JSON.stringify({ override: false })
  });
  show(r);
};

$("btnOverride").onclick = async () => {
  const id = $("installation_id").value.trim();
  const tok = $("installation_token").value.trim();
  const r = await api("/api/installations/" + encodeURIComponent(id) + "/actions/approve-can", {
    method: "POST",
    headers: { "x-installation-token": tok },
    body: JSON.stringify({ override: true, reason: $("override_reason").value })
  });
  show(r);
};
</script>
</body>
</html>
