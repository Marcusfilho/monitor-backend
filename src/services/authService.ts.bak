// src/services/authService.ts
import axios from "axios";

export interface TraffiTokenResponse {
  accessToken: string;
  expiresInSeconds: number;
  raw: any;
}

// Tipo gen√©rico da resposta da sua API de token.
// Depois podemos ajustar os campos de acordo com o JSON real.
interface AuthApiResponse {
  access_token?: string;
  token?: string;
  AccessToken?: string;
  jwt?: string;
  expires_in?: number;
  expiresIn?: number;
  // Qualquer outro campo que venha junto:
  [key: string]: any;
}

/**
 * Busca um novo token diretamente na API externa.
 * Aqui voc√™ depois vai ajustar URL, body e leitura do retorno
 * conforme sua cole√ß√£o de APIs.
 */
export async function fetchNewTraffiToken(): Promise<TraffiTokenResponse> {
  const url = process.env.TRAFFI_TOKEN_URL;
  const username = process.env.TRAFFI_USERNAME;
  const password = process.env.TRAFFI_PASSWORD;

  if (!url || !username || !password) {
    throw new Error("Vari√°veis de ambiente de auth n√£o configuradas.");
  }

  // üëá Aqui tipamos a resposta como AuthApiResponse
  const response = await axios.post<AuthApiResponse>(url, {
    username,
    password
  });

  const data = response.data;

  // TODO: ajustar esses campos conforme o JSON real da sua API
  const accessToken =
    data.access_token || data.token || data.AccessToken || data.jwt;
  const expiresInSeconds = data.expires_in || data.expiresIn || 3600;

  if (!accessToken) {
    console.error("Retorno da API de token:", JSON.stringify(data));
    throw new Error("API de token n√£o retornou accessToken reconhecido.");
  }

  return {
    accessToken,
    expiresInSec
}