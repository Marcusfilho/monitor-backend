<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>APP V1 - Installations (v1.3)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    input, select, button { padding: 8px; margin: 6px 0; width: 100%; max-width: 560px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-start; }
    .col { flex: 1; min-width: 280px; }
    pre { background: #111; color: #eee; padding: 12px; overflow: auto; max-height: 420px; }
    .muted { color: #666; font-size: 12px; }
    .warn { color: #b36b00; font-size: 12px; }
    .ok { color: #1a7f37; font-size: 12px; }
    hr { margin: 12px 0; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 12px; }
  
    /* === CAN Snapshot UI (raw_value) === */
    .tableWrap{ background:#111; border:1px solid #333; border-radius:8px; overflow:auto; max-height:260px; }
    table{ width:100%; border-collapse:collapse; font-size:12px; }
    th,td{ padding:6px 8px; border-bottom:1px solid #222; vertical-align:top; }
    th{ position:sticky; top:0; background:#161616; color:#cfe6ff; }
    details summary{ cursor:pointer; }
  
</style>
</head>
<body>
  <h2>APP V1 (provisório) — Installations (v1.3)</h2>
  <div class="muted">
    Layout alinhado ao plano: <b>1 Serial</b> + <b>1 Placa real</b>. O app calcula <span class="kbd">lookup_license</span> automaticamente:
    <br/>• INSTALL → lookup_license=serial
    <br/>• MAINT_*/UNINSTALL → lookup_license=placa real
    <br/>Compat: o payload também envia <span class="kbd">plate = lookup_license</span> para o worker atual.
  </div>

  <div class="row">
    <div class="col">
      <label>Service</label>
      <select id="service">
        <option>INSTALL</option>
        <option>UNINSTALL</option>
        <option>MAINT_NO_SWAP</option>
        <option>MAINT_WITH_SWAP</option>
      </select>

      <hr/>
      <div class="muted">Cliente + Setting (Monitor / Scheme Builder)</div>

      <label>Cliente (nome)</label>
      <select id="clientSelect"></select>
      <div class="muted" id="clientMeta"></div>

      <label>target_client_id</label>
      <input id="target_client_id" placeholder="ex: 218572" />

      <label>vehicleSettingId (Monitor)</label>
      <input id="vehicleSettingId" placeholder="ex: 5592" />

      <hr/>
      <div class="muted">Identificação do veículo</div>

      <label>Placa (real)</label>
      <input id="plate_real" placeholder="ex: BOI0A12" />
      <div class="muted">Sempre é a placa real do veículo (usada no SAVE como LICENSE_NMBR).</div>

      <div id="rowSerial">
        <label>Serial</label>
        <input id="serial" placeholder="ex: 913055459" />
        <div class="muted" id="serialHint"></div>
      </div>

      <label>lookup_license (auto)</label>
      <input id="lookup_license_auto" readonly />
      <div class="muted">É a chave usada no VHCLS (INSTALL=serial; demais=placa). Enviado também como <span class="kbd">plate</span> por compatibilidade.</div>

      <hr id="hrInstall"/>
      <div id="blockInstall">
        <div class="muted">Modelo (HTML5) — seleciona o <b>assetType</b> (vira ASSET_TYPE no SAVE_VHCL_ACTIVATION_NEW)</div>

        <label>Fabricante</label>
        <select id="cat_manufacturer"></select>

        <label>Modelo</label>
        <select id="cat_model"></select>

        <label>assetType (id do modelo)</label>
        <input id="assetType" readonly />
      </div>

      <hr/>
      <div class="muted">G-Sensor — orientação/instalação</div>

      <label>Etiqueta (label)</label>
      <select id="gs_label"></select>

      <label>Chicote (harness)</label>
      <select id="gs_harness"></select>

      <label>Comando (auto)</label>
      <input id="gs_command" readonly />

      <div class="muted">O payload envia: gsensor = { label, harness, command }.</div>

      <hr/>
      <button id="btnCreate">Criar instalação</button>

      <div class="muted">Preview do payload (antes de enviar)</div>
      <pre id="payloadPreview">{}</pre>
    </div>

    <div class="col">
      <label>installation_id</label>
      <input id="installation_id" />

      <label>installation_token</label>
      <input id="installation_token" />

      <div class="row">
        <button id="btnPoll" class="col">Poll status</button>
        <button id="btnSnap" class="col">Request CAN snapshot</button>
      </div>

      <div class="row">
        <button id="btnApprove" class="col">Approve CAN</button>
        <button id="btnOverride" class="col">Approve override</button>
      </div>

      <label>override reason</label>
      <input id="override_reason" value="vehicle_new_no_engineering" />

      <div class="muted">Saída do backend</div>
      <pre id="out">{}</pre>
      <div class="muted" style="margin-top:10px">CAN Snapshot (último)</div>
      <div class="muted" id="canSummary">snapshot: —</div>
      <input id="canFilter" placeholder="filtrar parâmetro (name/id/type)..." />

      <div class="muted" style="margin:10px 0 6px">Parameters</div>
      <div class="tableWrap">
        <table>
          <thead>
            <tr><th>name</th><th>type</th><th>value (value/raw_value)</th><th>last_update</th><th>source</th></tr>
          </thead>
          <tbody id="tblParamsBody"></tbody>
        </table>
      </div>

      <div class="muted" style="margin:12px 0 6px">Module State</div>
      <div class="tableWrap">
        <table>
          <thead>
            <tr><th>id</th><th>name</th><th>active</th><th>ok</th><th>was_ok</th><th>message</th></tr>
          </thead>
          <tbody id="tblMsBody"></tbody>
        </table>
      </div>

      <details style="margin-top:10px">
        <summary class="muted">JSON do snapshot</summary>
        <pre id="canOut">{}</pre>
      </details>

    </div>
  </div>

<script>
const $ = (id) => document.getElementById(id);

function saveLs() {
  localStorage.setItem("inst_id", $("installation_id").value || "");
  localStorage.setItem("inst_tok", $("installation_token").value || "");
}
function loadLs() {
  $("installation_id").value = localStorage.getItem("inst_id") || "";
  $("installation_token").value = localStorage.getItem("inst_tok") || "";
}
loadLs();

async function api(path, opts={}) {
  const headers = Object.assign({ "content-type": "application/json" }, opts.headers || {});
  const r = await fetch(path, Object.assign({}, opts, { headers }));
  const t = await r.text();
  let j = null;
  try { j = JSON.parse(t); } catch (_) { j = { raw: t }; }
  return { status: r.status, json: j };
}

function showOut(x) { $("out").textContent = JSON.stringify(x, null, 2); }

function showCanOut(x) { $("canOut").textContent = JSON.stringify(x, null, 2); }

const _canFilterEl = $("canFilter");
const _paramsBodyEl = $("tblParamsBody");
const _msBodyEl = $("tblMsBody");

let __LAST_CAN = { params: [], ms: [] };

function esc(s){
  return String(s==null?"":s).replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
}

function pick(obj, paths){
  for (const p of paths){
    let cur = obj; let ok = true;
    for (const k of p){
      if (cur && Object.prototype.hasOwnProperty.call(cur, k)) cur = cur[k];
      else { ok = false; break; }
    }
    if (ok && cur !== undefined && cur !== null) return cur;
  }
  return null;
}

function unwrapSnapshot(s){
  let cur = s;
  for (let i=0;i<4;i++){
    if (!cur || typeof cur !== "object") break;
    if (cur.snapshot) cur = cur.snapshot;
    else if (cur.data) cur = cur.data;
    else if (cur.payload) cur = cur.payload;
    else break;
  }
  return cur;
}

function lastOf(v){
  if (Array.isArray(v) && v.length) return v[v.length-1];
  return v;
}

function extractCanSnapshot(inst){
  const candidates = [
    lastOf(pick(inst, [["can","snapshots"],["can_snapshots"],["canSnapshots"]])),
    pick(inst, [["can_snapshot_latest"],["canSnapshotLatest"],["last_can_snapshot"],["lastCanSnapshot"]]),
    pick(inst, [["can_snapshot"],["canSnapshot"]]),
  ].filter(Boolean);
  if (!candidates.length) return null;
  return unwrapSnapshot(candidates[0]);
}

function displayValue(p){
  const v = (p && (p.value ?? p.val ?? p.current_value ?? p.currentValue ?? p.raw_value ?? p.rawValue));
  return (v===null || v===undefined) ? "" : String(v);
}

function extractRowsFromSnapshot(snap){
  if (!snap) return { params: [], ms: [] };
  const params =
    pick(snap, [["parameters"],["params"],["parameters_tab","rows"],["parametersTab","rows"],["tabs","parameters","rows"]]) || [];
  const moduleState =
    pick(snap, [["moduleState"],["module_state"],["module_state_tab","rows"],["moduleStateTab","rows"],["tabs","module_state","rows"]]) || [];

  const paramsRows = Array.isArray(params) ? params : (params && Array.isArray(params.rows) ? params.rows : []);
  const msRows = Array.isArray(moduleState) ? moduleState : (moduleState && Array.isArray(moduleState.rows) ? moduleState.rows : []);
  return { params: paramsRows, ms: msRows };
}

function renderParamsTable(rows, filter){
  const q = String(filter||"").trim().toLowerCase();
  let list = rows || [];
  if (q){
    list = list.filter(p => {
      const name = String(p?.name ?? "").toLowerCase();
      const id = String(p?.id ?? p?.param_id ?? p?.paramId ?? "").toLowerCase();
      const t = String(p?.param_type ?? p?.type ?? "").toLowerCase();
      return name.includes(q) || id.includes(q) || t.includes(q);
    });
  }

  const MAX = 250;
  const sliced = list.slice(0, MAX);

  _paramsBodyEl.innerHTML = sliced.map(p => {
    const name = esc(p?.name ?? "");
    const t = esc(p?.param_type ?? p?.type ?? "");
    const val = esc(displayValue(p));
    const lu = esc(p?.last_update ?? p?.lastUpdate ?? "");
    const src = esc(p?.source ?? "");
    return `<tr><td>${name}</td><td>${t}</td><td>${val}</td><td>${lu}</td><td>${src}</td></tr>`;
  }).join("") || `<tr><td colspan="5" class="muted">sem dados</td></tr>`;

  if (list.length > MAX){
    _paramsBodyEl.insertAdjacentHTML("beforeend", `<tr><td colspan="5" class="muted">… mostrando ${MAX} de ${list.length}</td></tr>`);
  }
}

function renderMsTable(rows){
  const MAX = 120;
  const sliced = (rows||[]).slice(0, MAX);
  _msBodyEl.innerHTML = sliced.map(r => {
    const id = esc(r?.id ?? r?.module_id ?? r?.moduleId ?? "");
    const name = esc(r?.name ?? r?.module_name ?? r?.moduleName ?? "");
    const active = esc(r?.active ?? "");
    const ok = esc(r?.ok ?? r?.is_ok ?? r?.isOk ?? "");
    const was = esc(r?.was_ok ?? r?.wasOk ?? "");
    const msg = esc(r?.message ?? r?.msg ?? "");
    return `<tr><td>${id}</td><td>${name}</td><td>${active}</td><td>${ok}</td><td>${was}</td><td>${msg}</td></tr>`;
  }).join("") || `<tr><td colspan="6" class="muted">sem dados</td></tr>`;

  if ((rows||[]).length > MAX){
    _msBodyEl.insertAdjacentHTML("beforeend", `<tr><td colspan="6" class="muted">… mostrando ${MAX} de ${(rows||[]).length}</td></tr>`);
  }
}

function renderCanFromInstallation(inst){
  const snap = extractCanSnapshot(inst);
  showCanOut({ snapshot: snap });

  const x = extractRowsFromSnapshot(snap);
  __LAST_CAN = x;

  const withValue = x.params.filter(p => displayValue(p).trim() !== "").length;
  $("canSummary").textContent = snap ? `params: ${x.params.length} (com valor: ${withValue}) | moduleState: ${x.ms.length}` : "snapshot: —";

  renderParamsTable(x.params, _canFilterEl ? _canFilterEl.value : "");
  renderMsTable(x.ms);
}

if (_canFilterEl){
  _canFilterEl.addEventListener("input", () => {
    renderParamsTable(__LAST_CAN.params, _canFilterEl.value);
  });
}

function showPayload(x) { $("payloadPreview").textContent = JSON.stringify(x, null, 2); }

function norm(v){ return String(v == null ? "" : v).trim(); }
function up(v){ return norm(v).toUpperCase(); }

function validatePayload(body){
  const errs = [];
  const svc = up(body.service);

  if (!norm(body.plate_real)) errs.push("Placa (real) é obrigatória");

  if (svc === "INSTALL"){
    if (!norm(body.serial)) errs.push("Serial é obrigatório para INSTALL");
    if (!body.target_client_id) errs.push("target_client_id é obrigatório para INSTALL");
    if (!body.assetType) errs.push("assetType é obrigatório para INSTALL");
  }

  if (svc === "MAINT_WITH_SWAP"){
    if (!norm(body.serial)) errs.push("Serial (novo) é obrigatório para MAINT_WITH_SWAP");
  }

  return errs;
}

// ===== Catálogos =====
let CATALOG_TYPES = [];      // catalog_vehicle_type.json
let CATALOG_SETTINGS = [];   // catalog_vehicle_settings.json
let GS_COMMANDS = [];        // g-sensor_commands.json

function uniqSorted(arr){ return [...new Set(arr)].sort((a,b)=>String(a).localeCompare(String(b))); }

async function loadJson(relPath){
  const r = await fetch(relPath, { cache: "no-store" });
  if (!r.ok) throw new Error(relPath + " HTTP " + r.status);
  return r.json();
}

async function loadCatalogs(){
  try {
    CATALOG_TYPES = await loadJson("catalog_vehicle_type.json");
    const s = await loadJson("catalog_vehicle_settings.json");
    CATALOG_SETTINGS = (s && s.items) ? s.items : [];
    const g = await loadJson("g-sensor_commands.json");
    GS_COMMANDS = (g && g.commands) ? g.commands : [];
  } catch (e) {
    showOut({ error: "Falha ao carregar JSONs. Confirme que estão na mesma pasta do HTML.", details: String(e) });
  }
  renderClients();
  renderManufacturers();
  renderGsSelectors();
  applyServiceUI();
  refreshPreview();
}

// ===== Cliente -> target_client_id + vehicleSettingId =====
function renderClients(){
  const sel = $("clientSelect");
  sel.innerHTML = "";
  const items = CATALOG_SETTINGS.slice().sort((a,b)=>
    String(a.clientName).localeCompare(String(b.clientName)) ||
    String(a.profileKey).localeCompare(String(b.profileKey))
  );

  for (const it of items){
    const o = document.createElement("option");
    o.value = String(it.clientId) + "|" + String(it.profileKey) + "|" + String(it.vehicleSettingId);
    o.textContent = `${it.clientName}  [${it.profileKey}]  → setting ${it.vehicleSettingId}` + (it.isDefault ? " (default)" : "");
    sel.appendChild(o);
  }

  const idx = items.findIndex(x => x.clientName === "TransLima" && x.profileKey === "default");
  if (idx >= 0) sel.selectedIndex = idx;

  applyClientSelection();
}

function applyClientSelection(){
  const v = $("clientSelect").value || "";
  const [clientId, profileKey, vehicleSettingId] = v.split("|");
  $("target_client_id").value = clientId || "";
  $("vehicleSettingId").value = vehicleSettingId || "";
  $("clientMeta").textContent = `clientId=${clientId} profileKey=${profileKey} vehicleSettingId=${vehicleSettingId}`;
  refreshPreview();
}
$("clientSelect").addEventListener("change", applyClientSelection);

// ===== Modelo -> assetType (HTML5) =====
function renderManufacturers(){
  const sel = $("cat_manufacturer");
  sel.innerHTML = "";
  const mans = uniqSorted(CATALOG_TYPES.map(x => x.manufacturer).filter(Boolean));
  for (const m of mans){
    const o = document.createElement("option");
    o.value = m; o.textContent = m;
    sel.appendChild(o);
  }
  renderModels();
}

function renderModels(){
  const man = $("cat_manufacturer").value;
  const sel = $("cat_model");
  sel.innerHTML = "";
  const models = uniqSorted(CATALOG_TYPES.filter(x => x.manufacturer === man).map(x => x.model).filter(Boolean));
  for (const m of models){
    const o = document.createElement("option");
    o.value = m; o.textContent = m;
    sel.appendChild(o);
  }
  updateAssetType();
}

function updateAssetType(){
  const man = $("cat_manufacturer").value;
  const model = $("cat_model").value;
  const it = CATALOG_TYPES.find(x => x.manufacturer === man && x.model === model);
  $("assetType").value = it ? String(it.asset_type) : "";
  refreshPreview();
}
$("cat_manufacturer").addEventListener("change", () => { renderModels(); });
$("cat_model").addEventListener("change", updateAssetType);

// ===== G-Sensor: label+harness -> command =====
function renderGsSelectors(){
  const labels = uniqSorted(GS_COMMANDS.map(x => x.label).filter(Boolean));
  const harness = uniqSorted(GS_COMMANDS.map(x => x.harness).filter(Boolean));

  const selL = $("gs_label"); selL.innerHTML = "";
  for (const l of labels){ const o=document.createElement("option"); o.value=l; o.textContent=l; selL.appendChild(o); }

  const selH = $("gs_harness"); selH.innerHTML = "";
  for (const h of harness){ const o=document.createElement("option"); o.value=h; o.textContent=h; selH.appendChild(o); }

  updateGsCommand();
}
function updateGsCommand(){
  const l = $("gs_label").value;
  const h = $("gs_harness").value;
  const it = GS_COMMANDS.find(x => x.label === l && x.harness === h);
  $("gs_command").value = it ? String(it.command) : "";
  refreshPreview();
}
$("gs_label").addEventListener("change", updateGsCommand);
$("gs_harness").addEventListener("change", updateGsCommand);

// ===== UI por serviço =====
function applyServiceUI(){
  const svc = $("service").value;
  const isInstall = (svc === "INSTALL");

  $("blockInstall").style.display = isInstall ? "" : "none";
  $("hrInstall").style.display = isInstall ? "" : "none";

  // serial necessário em INSTALL e MAINT_WITH_SWAP; oculto nos demais
  const wantSerial = (svc === "INSTALL" || svc === "MAINT_WITH_SWAP");
  $("rowSerial").style.display = wantSerial ? "" : "none";

  $("serialHint").textContent =
    (svc === "INSTALL")
      ? "INSTALL: este serial será usado como lookup_license (bancada: license=serial)."
      : (svc === "MAINT_WITH_SWAP")
        ? "MAINT_WITH_SWAP: este é o serial novo a instalar."
        : "";

  refreshPreview();
}
$("service").addEventListener("change", applyServiceUI);

// ===== Build payload (canônico) =====
function buildPayload(){
  const svc = $("service").value;

  const plateReal = norm($("plate_real").value);
  const serial = norm($("serial").value);

  // regra do plano: INSTALL procura por serial; demais procuram por placa real
  const lookup = (svc === "INSTALL") ? serial : plateReal;

  $("lookup_license_auto").value = lookup;

  const body = {
    service: svc,

    // catálogo/monitor
    target_client_id: Number($("target_client_id").value || 0) || null,
    vehicleSettingId: Number($("vehicleSettingId").value || 0) || null,

    // canônico
    plate_real: plateReal || null,
    serial: serial || "",

    // chave VHCLS
    lookup_license: lookup || null,

    // compat worker atual
    plate: lookup || null,

    // SAVE helper (compat)
    LICENSE_NMBR: plateReal || null,
    INNER_ID: serial || null,
    DIAL_NUMBER: serial || null,

    gsensor: {
      label: $("gs_label").value,
      harness: $("gs_harness").value,
      command: $("gs_command").value
    }
  };

  if (svc === "INSTALL") {
    const assetType = Number($("assetType").value || 0) || null;
    body.assetType = assetType;
    body.vehicle = {
      manufacturer: $("cat_manufacturer").value,
      model: $("cat_model").value,
      year: null
    };
  }

  // regra: não mandar assetType fora do INSTALL
  if (svc !== "INSTALL") delete body.assetType;

  // UNINSTALL / MAINT_NO_SWAP não precisam de serial no payload final
  if (svc === "UNINSTALL" || svc === "MAINT_NO_SWAP") body.serial = "";

  return body;
}

function refreshPreview(){ showPayload(buildPayload()); }
["target_client_id","vehicleSettingId","plate_real","serial"].forEach(id => {
  $(id).addEventListener("input", refreshPreview);
});

$("btnCreate").onclick = async () => {
  const body = buildPayload();
  showPayload(body);

  const errs = validatePayload(body);
  if (errs.length) {
    alert("Payload inválido:\n- " + errs.join("\n- "));
    return;
  }

  const r = await api("/api/installations", { method: "POST", body: JSON.stringify(body) });
  showOut(r);
  if (r.json && r.json.ok) {
    $("installation_id").value = r.json.installation_id;
    $("installation_token").value = r.json.installation_token;
    saveLs();
  }
};

$("btnPoll").onclick = async () => {
  const id = $("installation_id").value.trim();
  const r = await api("/api/installations/" + encodeURIComponent(id));
  showOut(r);

  if (r && r.json) renderCanFromInstallation(r.json);
};

$("btnSnap").onclick = async () => {
  const id = $("installation_id").value.trim();
  const tok = $("installation_token").value.trim();
  const r = await api("/api/installations/" + encodeURIComponent(id) + "/actions/request-can-snapshot", {
    method: "POST",
    headers: { "x-installation-token": tok },
    body: "{}"
  });
  showOut(r);
};

$("btnApprove").onclick = async () => {
  const id = $("installation_id").value.trim();
  const tok = $("installation_token").value.trim();
  const r = await api("/api/installations/" + encodeURIComponent(id) + "/actions/approve-can", {
    method: "POST",
    headers: { "x-installation-token": tok },
    body: JSON.stringify({ override: false })
  });
  showOut(r);
};

$("btnOverride").onclick = async () => {
  const id = $("installation_id").value.trim();
  const tok = $("installation_token").value.trim();
  const r = await api("/api/installations/" + encodeURIComponent(id) + "/actions/approve-can", {
    method: "POST",
    headers: { "x-installation-token": tok },
    body: JSON.stringify({ override: true, reason: $("override_reason").value })
  });
  showOut(r);
};

loadCatalogs();
applyServiceUI();
refreshPreview();
</script>
</body>
</html>
