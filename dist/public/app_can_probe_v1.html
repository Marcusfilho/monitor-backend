
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CAN Probe — Vehicle Monitor snapshot</title>
  <style>
    :root{
      --bg:#0b0f12; --panel:#0f1620; --muted:#93a4b8; --text:#e8eef2; --line:#1f2a38;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:var(--sans)}
    header{padding:16px 18px;border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center;justify-content:space-between}
    header h1{margin:0;font-size:16px;font-weight:700}
    header .nav{display:flex;gap:10px;align-items:center;font-size:12px}
    header a{color:#cfe6ff;text-decoration:none;border:1px solid var(--line);padding:6px 10px;border-radius:10px;background:#0b1118}
    .wrap{padding:16px 18px}
    .grid{display:grid;grid-template-columns: 420px 1fr; gap:14px; align-items:start}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
    .card h2{margin:0 0 10px 0;font-size:13px;color:#cfe6ff}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input, textarea{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid #273245;background:#0b1118;color:var(--text);outline:none;
      font-family:var(--sans);font-size:13px
    }
    textarea{min-height:70px;resize:vertical}
    button{
      cursor:pointer;border:1px solid #2a3a52;background:#122033;color:#e8eef2;border-radius:12px;padding:10px 12px;font-weight:650;
    }
    button:hover{border-color:#3b5478}
    button.secondary{background:#0b1118}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap}
    .hint{font-size:12px;color:var(--muted);line-height:1.4;margin-top:10px}
    .status{font-family:var(--mono);font-size:12px;color:var(--muted);margin-top:10px}
    pre{
      margin:0; padding:12px; border-radius:14px; border:1px solid #273245;
      background:#000; color:#e8eef2; font-family:var(--mono); font-size:12px; line-height:1.35;
      overflow:auto; max-height: 74vh;
    }
  
    /* === CAN Snapshot UI (raw_value) === */
    .kv{font-size:12px;color:var(--muted);margin:8px 0 10px;display:flex;gap:10px;flex-wrap:wrap}
    .pill{border:1px solid #273245;background:#0b1118;padding:4px 8px;border-radius:999px}
    .tableWrap{border:1px solid #273245;border-radius:14px;overflow:auto;max-height:32vh;background:#000}
    table{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:12px}
    th,td{padding:7px 10px;border-bottom:1px solid #1f2a38;vertical-align:top}
    th{position:sticky;top:0;background:#0b1118;color:#cfe6ff}
    tr:hover td{background:#0b1118}
    details summary{cursor:pointer;color:#cfe6ff;font-size:12px;margin:10px 0}
  
</style>
</head>
<body>
<header>
  <h1>CAN Probe <span style="opacity:.8;font-size:12px">— cria instalação CAN_PROBE e puxa snapshot</span></h1>
  <div class="nav">
    <a href="/app/app_installations_v2.html">Voltar (v2)</a>
    <a href="/app/app_installations_v1.html">v1</a>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <div class="card">
      <h2>1) Criar “instalação probe” (sem HTML5/SB)</h2>

      <label>vehicle_id (real, online)</label>
      <input id="vehicle_id" placeholder="ex.: 1940478" />

      <label>target_client_id (opcional)</label>
      <input id="target_client_id" placeholder="ex.: 218572" />

      <label>vehicleSettingId (opcional)</label>
      <input id="vehicleSettingId" placeholder="ex.: 5592" />

      <label>comments (opcional)</label>
      <textarea id="comments" placeholder="ex.: CAN PROBE..."></textarea>

      <div class="btnrow" style="margin-top:12px">
        <button id="btnCreate">Criar CAN_PROBE</button>
        <button class="secondary" id="btnReq">Request snapshot</button>
        <button class="secondary" id="btnLoad">Carregar</button>
        <button class="secondary" id="btnApprove">Aprovar CAN</button>
      </div>

      <hr style="border:none;border-top:1px solid var(--line);margin:14px 0" />

      <h2>2) Ou inspecionar um installation_id existente</h2>
      <label>installation_id</label>
      <input id="installation_id" placeholder="inst_..." />

      <div class="hint">
        <div>• Esse probe depende do backend aceitar <b>service=CAN_PROBE</b> sem enfileirar job HTML5.</div>
        <div>• Depois você usa <b>Request snapshot</b> e vai recarregando até aparecer CAN.</div>
      </div>

      <div class="status" id="status">status: pronto</div>
    </div>

    <div class="card">
      <h2>CAN Snapshot (último)</h2>
      <div class="kv" id="canSummary">
        <span class="pill">snapshot: —</span>
        <span class="pill" id="pillParams">params: 0</span>
        <span class="pill" id="pillParamsWith">com valor: 0</span>
        <span class="pill" id="pillMs">module: 0</span>
      </div>

      <label style="margin-top:8px">Filtro (Parameters)</label>
      <input id="canFilter" placeholder="filtrar por name / id / type..." />

      <div class="muted" style="font-size:12px;color:var(--muted);margin:10px 0 6px">Parameters</div>
      <div class="tableWrap">
        <table>
          <thead>
            <tr><th>name</th><th>type</th><th>value (value/raw_value)</th><th>last_update</th><th>source</th></tr>
          </thead>
          <tbody id="tblParamsBody"></tbody>
        </table>
      </div>

      <div class="muted" style="font-size:12px;color:var(--muted);margin:12px 0 6px">Module State</div>
      <div class="tableWrap">
        <table>
          <thead>
            <tr><th>id</th><th>name</th><th>active</th><th>ok</th><th>was_ok</th><th>message</th></tr>
          </thead>
          <tbody id="tblMsBody"></tbody>
        </table>
      </div>

      <details>
        <summary>JSON (inst + snapshot)</summary>
        <pre id="out">{}</pre>
      </details>
    </div>
  </div>
</div>

<script>
  const qs = (id) => document.getElementById(id);
  const outEl = qs("out");
  const statusEl = qs("status");
  let LAST_INST = null;

  function setStatus(msg){ statusEl.textContent = "status: " + msg; }
  function pretty(obj){ try { return JSON.stringify(obj, null, 2); } catch(e){ return String(obj); } }

  async function api(path, { method="GET", json=null } = {}){
    const res = await fetch(path, {
      method,
      headers: json ? { "content-type":"application/json" } : {},
      body: json ? JSON.stringify(json) : undefined
    });
    const text = await res.text().catch(()=>"");
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch { data = text; }
    return { status: res.status, data };
  }

  function instIdOf(inst){
    return inst?.installation_id || inst?.id || inst?.installationId || null;
  }

  function pick(obj, paths){
    for (const p of paths){
      let cur = obj; let ok = true;
      for (const k of p){
        if (cur && Object.prototype.hasOwnProperty.call(cur, k)) cur = cur[k];
        else { ok = false; break; }
      }
      if (ok && cur !== undefined && cur !== null) return cur;
    }
    return null;
  }

  function unwrapSnapshot(s){
    let cur = s;
    for (let i=0;i<4;i++){
      if (!cur || typeof cur !== "object") break;
      if (cur.snapshot) cur = cur.snapshot;
      else if (cur.data) cur = cur.data;
      else if (cur.payload) cur = cur.payload;
      else break;
    }
    return cur;
  }

  function lastOf(v){
    if (Array.isArray(v) && v.length) return v[v.length-1];
    return v;
  }

  function extractCanSnapshot(inst){
    const candidates = [
      lastOf(pick(inst, [["can","snapshots"],["can","snapShots"]])),
      lastOf(pick(inst, [["can_snapshots"],["canSnapshots"]])),
      pick(inst, [["can_snapshot_latest"],["canSnapshotLatest"],["last_can_snapshot"],["lastCanSnapshot"]]),
      pick(inst, [["can_snapshot"],["canSnapshot"]]),
      lastOf(pick(inst, [["can_snapshots"],["canSnapshots"]])),
      lastOf(pick(inst, [["snapshots","can"],["snapshots","can_snapshots"],["snapshots","canSnapshots"]])),
      pick(inst, [["monitor","can_snapshot"],["monitor","snapshot"],["monitorSnapshot"]]),
      pick(inst, [["can"],["monitor_snapshot"]])
    ].filter(Boolean);
    if (!candidates.length) return null;
    return unwrapSnapshot(candidates[0]);
  }


  // === CAN Snapshot render (raw_value) ===
  const canFilterEl = qs("canFilter");
  const paramsBodyEl = qs("tblParamsBody");
  const msBodyEl = qs("tblMsBody");
  const pillParamsEl = qs("pillParams");
  const pillParamsWithEl = qs("pillParamsWith");
  const pillMsEl = qs("pillMs");

  let __LAST_CAN = { params: [], ms: [] };

  function esc(s){
    return String(s==null?"":s).replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
  }

  function displayValue(p){
    const v = (p && (p.value ?? p.val ?? p.current_value ?? p.currentValue ?? p.raw_value ?? p.rawValue));
    return (v===null || v===undefined) ? "" : String(v);
  }

  function extractRowsFromSnapshot(snap){
    if (!snap) return { params: [], ms: [] };

    const params =
      pick(snap, [["parameters"],["params"],["parameters_tab","rows"],["parametersTab","rows"],["tabs","parameters","rows"]]) || [];
    const moduleState =
      pick(snap, [["moduleState"],["module_state"],["module_state_tab","rows"],["moduleStateTab","rows"],["tabs","module_state","rows"]]) || [];

    const paramsRows = Array.isArray(params) ? params : (params && Array.isArray(params.rows) ? params.rows : []);
    const msRows = Array.isArray(moduleState) ? moduleState : (moduleState && Array.isArray(moduleState.rows) ? moduleState.rows : []);

    return { params: paramsRows, ms: msRows };
  }

  function renderParamsTable(rows, filter){
    const q = String(filter||"").trim().toLowerCase();
    let list = rows || [];
    if (q){
      list = list.filter(p => {
        const name = String(p?.name ?? "").toLowerCase();
        const id = String(p?.id ?? p?.param_id ?? p?.paramId ?? "").toLowerCase();
        const t = String(p?.param_type ?? p?.type ?? "").toLowerCase();
        return name.includes(q) || id.includes(q) || t.includes(q);
      });
    }

    const MAX = 250;
    const sliced = list.slice(0, MAX);

    paramsBodyEl.innerHTML = sliced.map(p => {
      const name = esc(p?.name ?? "");
      const t = esc(p?.param_type ?? p?.type ?? "");
      const val = esc(displayValue(p));
      const lu = esc(p?.last_update ?? p?.lastUpdate ?? "");
      const src = esc(p?.source ?? "");
      return `<tr><td>${name}</td><td>${t}</td><td>${val}</td><td>${lu}</td><td>${src}</td></tr>`;
    }).join("") || `<tr><td colspan="5" style="color:#93a4b8">sem dados</td></tr>`;

    if (list.length > MAX){
      paramsBodyEl.insertAdjacentHTML("beforeend", `<tr><td colspan="5" style="color:#93a4b8">… mostrando ${MAX} de ${list.length}</td></tr>`);
    }
  }

  function renderMsTable(rows){
    const MAX = 120;
    const sliced = (rows||[]).slice(0, MAX);
    msBodyEl.innerHTML = sliced.map(r => {
      const id = esc(r?.id ?? r?.module_id ?? r?.moduleId ?? "");
      const name = esc(r?.name ?? r?.module_name ?? r?.moduleName ?? "");
      const active = esc(r?.active ?? "");
      const ok = esc(r?.ok ?? r?.is_ok ?? r?.isOk ?? "");
      const was = esc(r?.was_ok ?? r?.wasOk ?? "");
      const msg = esc(r?.message ?? r?.msg ?? "");
      return `<tr><td>${id}</td><td>${name}</td><td>${active}</td><td>${ok}</td><td>${was}</td><td>${msg}</td></tr>`;
    }).join("") || `<tr><td colspan="6" style="color:#93a4b8">sem dados</td></tr>`;

    if ((rows||[]).length > MAX){
      msBodyEl.insertAdjacentHTML("beforeend", `<tr><td colspan="6" style="color:#93a4b8">… mostrando ${MAX} de ${(rows||[]).length}</td></tr>`);
    }
  }

  function renderCanSnapshot(snap){
    const x = extractRowsFromSnapshot(snap);
    __LAST_CAN = x;

    const withValue = x.params.filter(p => displayValue(p).trim() !== "").length;

    pillParamsEl.textContent = `params: ${x.params.length}`;
    pillParamsWithEl.textContent = `com valor: ${withValue}`;
    pillMsEl.textContent = `module: ${x.ms.length}`;

    renderParamsTable(x.params, (canFilterEl && canFilterEl.value) ? canFilterEl.value : "");
    renderMsTable(x.ms);
  }

  if (canFilterEl){
    canFilterEl.addEventListener("input", () => {
      renderParamsTable(__LAST_CAN.params, canFilterEl.value);
    });
  }


  async function loadInstallation(id){
    setStatus("carregando...");
    const r = await api(`/api/installations/${encodeURIComponent(id)}`);
    if (r.status === 200 && r.data){
      const inst = r.data;
      LAST_INST = inst;
      const snap = extractCanSnapshot(inst);
      
      
          renderCanSnapshot(snap);
renderCanSnapshot(snap);
outEl.textContent = pretty({ installation: inst, can_snapshot: snap });
      qs("installation_id").value = instIdOf(inst) || id;
      localStorage.setItem("can_probe_last_installation_id", instIdOf(inst) || id);

      const st = (inst && inst.status) ? String(inst.status) : "ok";
      setStatus(st);
    } else {
      outEl.textContent = pretty(r);
      if (r.status === 404){
        // id antigo no localStorage costuma causar confusão
        try { localStorage.removeItem("can_probe_last_installation_id"); } catch(_){}
        setStatus("installation_id não encontrado (limpei o cache local)");
      } else {
        setStatus("erro ao carregar");
      }
    }
    return r;
  }

  async function createProbe(){
    const vehicleId = qs("vehicle_id").value.trim();
    if (!vehicleId) return setStatus("informe vehicle_id");
    setStatus("criando CAN_PROBE...");
    const payload = {
      service: "CAN_PROBE",
      vehicle_id: vehicleId,
      vehicleId: vehicleId,
      target_client_id: qs("target_client_id").value.trim() || null,
      vehicleSettingId: qs("vehicleSettingId").value.trim() || null,
      comments: qs("comments").value || null,
      installationDate: new Date().toISOString()
    };
    const r = await api("/api/installations", { method:"POST", json: payload });
    outEl.textContent = pretty(r);
    if (r.status === 201 && r.data){
      const id = instIdOf(r.data);
      if (id){
        qs("installation_id").value = id;
        setStatus("criado — carregando...");
        await loadInstallation(id);
      } else {
        setStatus("criado (sem id no retorno)");
      }
    } else {
      setStatus("erro ao criar");
    }
  }

  async function requestSnapshot(){
    const id = qs("installation_id").value.trim();
    if (!id) return setStatus("informe installation_id");

    // resolve vehicle_id: input -> last loaded installation -> payload
    let vehicle_id = Number(qs("vehicle_id").value.trim());
    if (!Number.isFinite(vehicle_id) || vehicle_id <= 0){
      const v = pick(LAST_INST, [
        ["resolved","vehicle_id"],
        ["payload","vehicle_id"],
        ["payload","vehicleId"],
        ["vehicle_id"],
        ["vehicleId"]
      ]);
      vehicle_id = (v != null) ? Number(v) : NaN;
    }
    if (!Number.isFinite(vehicle_id) || vehicle_id <= 0){
      return setStatus("informe vehicle_id (input ou payload/resolved)");
    }

    setStatus("request snapshot...");
    const r = await api(`/api/installations/${encodeURIComponent(id)}/actions/request-can-snapshot`, {
      method:"POST",
      json:{ vehicle_id }
    });

    // mostra resposta do POST (útil p/ headers/erros)
    outEl.textContent = pretty({ request: r });

    if (r.status >= 400){
      setStatus("erro no request snapshot");
      return;
    }

    // polling: esperar backend preencher can.summary/snapshots
    await pollCan(id);
  }

  async function pollCan(id, { tries=30, sleepMs=3000 } = {}){
    for (let i=0; i<tries; i++){
      const r = await api(`/api/installations/${encodeURIComponent(id)}`);
      if (r.status === 200 && r.data){
        const inst = r.data;
        LAST_INST = inst;
        const snap = extractCanSnapshot(inst);
        outEl.textContent = pretty({
          poll: { attempt: i+1, tries, inst_status: inst.status || null },
          installation: inst,
          can_snapshot: snap
        });

        const hasSummary = !!(snap && snap.summary);
        const hasList = !!(snap && Array.isArray(snap.snapshots) && snap.snapshots.length);
        if (hasSummary || hasList){
          setStatus("CAN pronto ✅");
          return r;
        }
      } else {
        outEl.textContent = pretty({ poll: { attempt: i+1, tries }, error: r });
      }

      setStatus(`aguardando CAN... (${i+1}/${tries})`);
      await new Promise(res => setTimeout(res, sleepMs));
    }
    setStatus("timeout aguardando CAN — use Carregar");
    return null;
  }

async function approveCan(){
    const id = qs("installation_id").value.trim();
    if (!id) return setStatus("informe installation_id");
    setStatus("aprovando CAN...");
    const r = await api(`/api/installations/${encodeURIComponent(id)}/actions/approve-can`, { method:"POST", json:{} });
    outEl.textContent = pretty(r);
    await loadInstallation(id);
  }

  qs("btnCreate").addEventListener("click", createProbe);
  qs("btnReq").addEventListener("click", requestSnapshot);
  qs("btnLoad").addEventListener("click", () => loadInstallation(qs("installation_id").value.trim()));
  qs("btnApprove").addEventListener("click", approveCan);

  const last = localStorage.getItem("can_probe_last_installation_id");
  if (last){
    qs("installation_id").value = last;
    loadInstallation(last).catch(()=>{});
  }
</script>
</body>
</html>
